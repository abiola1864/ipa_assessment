<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPA Technical Assessment Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
            /* Copy protection styles - but exclude access code input */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Allow copy/paste ONLY for access code input */
        .access-code-input {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
        }

        /* Disable right-click context menu */
        body {
            -webkit-context-menu: none;
            -moz-context-menu: none;
            -ms-context-menu: none;
            context-menu: none;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .ipa-logo {
            max-width: 220px;
            height: auto;
            filter: drop-shadow(0 2px 10px rgba(0,0,0,0.1));
        }

        .header h1 {
            color: #11853d;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .project-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8fbff 100%);
            border-left: 5px solid #2196F3;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.1);
        }

        .project-info h4 {
            color: #1976d2;
            margin-bottom: 12px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .project-info p {
            color: #555;
            font-size: 15px;
            margin: 0;
            line-height: 1.7;
        }

        .organization-info {
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5f0 100%);
            border-left: 5px solid #11853d;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(17, 133, 61, 0.1);
        }

        .organization-info h4 {
            color: #11853d;
            margin-bottom: 12px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .organization-info p {
            color: #555;
            font-size: 15px;
            margin: 0;
            line-height: 1.7;
        }

        .timer {
            background: #ff4444;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            float: right;
            box-shadow: 0 2px 10px rgba(255, 68, 68, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11853d 0%, #16a852 100%);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .question-info {
            color: #666;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .question {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.7;
            white-space: pre-line;
            color: #333;
            /* Additional copy protection for questions */
            pointer-events: none;
        }

        .options {
            list-style: none;
            margin-bottom: 30px;
        }

        .option {
            margin-bottom: 15px;
            padding: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            /* Allow interaction for options */
            pointer-events: auto;
        }

        .option:hover {
            border-color: #11853d;
            background: #f8fffe;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(17, 133, 61, 0.1);
        }

        .option.selected {
            border-color: #11853d;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5f0 100%);
            box-shadow: 0 4px 15px rgba(17, 133, 61, 0.2);
        }

        .option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #11853d 0%, #16a852 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17, 133, 61, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 133, 61, 0.4);
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #555;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .question-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .question-number {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid #ddd;
            background: white;
            transition: all 0.3s ease;
        }

        .question-number:hover {
            transform: scale(1.1);
        }

        .question-number.answered {
            background: #11853d;
            color: white;
            border-color: #11853d;
        }

        .question-number.current {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
            transform: scale(1.15);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #11853d;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #11853d;
            box-shadow: 0 0 0 3px rgba(17, 133, 61, 0.1);
        }

        .quiz-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8fbff 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #e1f5fe;
        }

        .quiz-info h3 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .quiz-info ul {
            margin-left: 20px;
        }

        .quiz-info li {
            margin-bottom: 10px;
            color: #1976d2;
            font-weight: 500;
        }

        .completion-card {
            text-align: center;
            padding: 50px;
        }

        .completion-icon {
            font-size: 5em;
            margin-bottom: 25px;
        }

        .score-display {
            background: linear-gradient(135deg, #f5f5f5 0%, #fff 100%);
            padding: 40px;
            border-radius: 15px;
            margin: 25px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .score-number {
            font-size: 3.5em;
            font-weight: bold;
            color: #11853d;
        }

        .grade-badge {
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            margin-top: 15px;
            display: inline-block;
            font-size: 1.1em;
        }

        .excellent { background: linear-gradient(135deg, #11853d 0%, #16a852 100%); }
        .good { background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); }
        .needs-improvement { background: linear-gradient(135deg, #f44336 0%, #e57373 100%); }

        .validation-error {
            background: #ffebee;
            color: #c62828;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
            font-weight: 500;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #11853d;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .submission-status {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 18px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #11853d;
        }

        .detailed-results {
            text-align: left;
            margin-top: 30px;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .result-question {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }

        .result-question.correct {
            background: #e8f5e8;
            border-left-color: #11853d;
        }

        .result-question.incorrect {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .result-question h4 {
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
        }

        .result-details {
            font-size: 14px;
            margin-top: 10px;
        }

        .your-answer {
            color: #f44336;
            font-weight: bold;
        }

        .correct-answer {
            color: #11853d;
            font-weight: bold;
        }

        .explanation {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-style: italic;
            line-height: 1.5;
        }

        .hidden {
            display: none;
        }

        .access-code-input {
            text-align: center;
            text-transform: uppercase;
            font-size: 1.2em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* Copy protection overlay */
        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-size: 1.5em;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 25px;
            }
            
            .timer {
                float: none;
                display: block;
                text-align: center;
                margin-bottom: 20px;
            }
            
            .question-grid {
                justify-content: center;
            }

            .ipa-logo {
                max-width: 180px;
            }

            .header h1 {
                font-size: 2.2em;
            }

            .project-info, .organization-info {
                padding: 20px;
            }

            .quiz-info {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Copy Protection Overlay -->
    <div id="protectionOverlay" class="protection-overlay">
        <div>
            <h2>⚠️ Copying Disabled</h2>
            <p>This assessment is protected. Please use only your own knowledge.</p>
        </div>
    </div>

    <div class="container">
        <!-- Access Code Screen -->
        <div id="accessScreen" class="card">
            <div class="header">
                <div class="logo-section">
                    <img src="images/ipalogo.png" 
                         alt="IPA - Innovations for Poverty Action" 
                         class="ipa-logo">
                </div>
                <h1>Technical Assessment</h1>
                <p class="subtitle">Innovations for Poverty Action</p>
            </div>

            <div class="organization-info">
                <h4>Project Access Required</h4>
                <p>This technical assessment requires a valid project access code. Please enter the code provided by your administrator to begin the assessment.</p>
            </div>

            <div class="form-group">
                <label for="accessCode">Project Access Code:</label>
                <input type="text" 
                       id="accessCode" 
                       class="access-code-input"
                       placeholder="Enter access code" 
                       maxlength="10">
            </div>

            <div id="accessError" class="validation-error hidden">
                ⚠️ Invalid access code. Please check your code and try again.
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="validateAccess()" id="accessBtn">
                    Validate Access Code
                </button>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="card hidden">
            <div class="header">
                <div class="logo-section">
                    <img src="images/ipalogo.png" 
                         alt="IPA - Innovations for Poverty Action" 
                         class="ipa-logo">
                </div>
                <h1>Technical Assessment</h1>
                <p class="subtitle">Innovations for Poverty Action</p>
            </div>

            <!-- Project Information -->
            <div id="projectInfo" class="project-info">
                <h4 id="projectName">Loading Project...</h4>
                <p id="projectDescription">Project details will appear here.</p>
            </div>

            <!-- Assessment Information -->
            <div class="organization-info">
                <h4>Assessment Overview</h4>
                <p>This technical assessment evaluates expertise in data analysis, monitoring & evaluation, impact evaluation methodology, and programming logic for evidence-based research and policy implementation.</p>
            </div>

            <div class="quiz-info" id="quizInfo">
                <h3>Assessment Information:</h3>
                <ul id="assessmentDetails">
                    <li>Loading assessment details...</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="participantName">Your Full Name:</label>
                <input type="text" id="participantName" placeholder="Enter your full name" maxlength="50">
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="startQuiz()" id="startBtn">
                    Start Assessment
                </button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hidden">
            <!-- Header -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 id="questionTitle">Question 1 of 20</h2>
                        <div class="question-info" id="questionInfo">Loading...</div>
                    </div>
                    <div class="timer" id="timer">30:00</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 5%;"></div>
                </div>
            </div>

            <!-- Question -->
            <div class="card">
                <div id="validationError" class="validation-error hidden">
                    ⚠️ Please select an answer before proceeding to the next question.
                </div>

                <div class="question" id="questionText">
                    Loading question...
                </div>

                <ul class="options" id="optionsList">
                    <!-- Options will be populated by JavaScript -->
                </ul>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevQuestion()" id="prevBtn" disabled>
                        Previous
                    </button>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">
                            Next
                        </button>
                        <button class="btn btn-danger hidden" onclick="submitQuiz()" id="submitBtn">
                            Submit Assessment
                        </button>
                    </div>
                </div>

                <!-- Question Navigation Grid -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="margin-bottom: 15px; color: #666;">Question Status:</p>
                    <div class="question-grid" id="questionGrid">
                        <!-- Question numbers will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="hidden">
            <div class="card completion-card">
                <div class="completion-icon" id="completionIcon">🎉</div>
                <h2>Assessment Completed!</h2>
                <p id="thankYouMessage">Thank you for completing the technical assessment!</p>

                <div class="score-display">
                    <div class="score-number" id="finalScore">20/20</div>
                    <div style="font-size: 1.5em; margin: 10px 0;" id="finalPercentage">100%</div>
                    <div class="grade-badge excellent" id="gradeBadge">Excellent</div>
                </div>

                <div id="submissionStatus" class="submission-status hidden">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <p id="statusMessage">Submitting your results...</p>
                </div>

                <!-- Detailed Results Section -->
                <div id="detailedResultsContainer" class="detailed-results">
                    <h3 style="margin-bottom: 20px; text-align: center;">Detailed Results</h3>
                    <div id="detailedResultsList">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <p style="margin-top: 30px; color: #666; font-size: 14px;">
                    Your results have been saved to the database for analysis and reporting purposes.
                </p>

                <div style="margin-top: 30px;">
                    <!-- <button class="btn btn-primary" onclick="resetQuiz()" id="resetBtn">
                        Take Assessment Again
                    </button> -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestionIndex = 0;
        let answers = {};
        let participantName = '';
        let timeLeft = 1800; // Default 30 minutes, will be updated from project
        let timerInterval;
        let quizStartTime;
        let questions = [];
        let projectData = null;

        // Copy protection - Modified to allow access code input
        document.addEventListener('contextmenu', function(e) {
            // Allow right-click on access code input
            if (e.target.id === 'accessCode') {
                return true;
            }
            e.preventDefault();
        });

        document.addEventListener('keydown', function(e) {
            // Allow copy/paste for access code input only
            if (e.target.id === 'accessCode') {
                return true;
            }
            
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S, Ctrl+A, Ctrl+C, Ctrl+V
            if (e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
                (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86))) {
                e.preventDefault();
                showProtectionOverlay();
                return false;
            }
        });

        document.addEventListener('selectstart', function(e) {
            // Allow selection for access code input
            if (e.target.id === 'accessCode') {
                return true;
            }
            e.preventDefault();
        });

        document.addEventListener('dragstart', function(e) {
            // Allow drag for access code input
            if (e.target.id === 'accessCode') {
                return true;
            }
            e.preventDefault();
        });

        function showProtectionOverlay() {
            const overlay = document.getElementById('protectionOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2000);
        }

        // Validate access code
        async function validateAccess() {
            const accessCode = document.getElementById('accessCode').value.trim();
            const accessBtn = document.getElementById('accessBtn');
            const errorDiv = document.getElementById('accessError');
            
            if (!accessCode) {
                showAccessError('Please enter an access code.');
                return;
            }

            accessBtn.disabled = true;
            accessBtn.textContent = 'Validating...';
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/validate-access-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ access_code: accessCode })
                });

                const result = await response.json();

                if (result.success) {
                    // Store project data and questions
                    projectData = result.project;
                    questions = result.questions;
                    timeLeft = projectData.time_limit;
                    
                    // Update UI with project information
                    updateProjectInfo();
                    
                    // Hide access screen, show start screen
                    document.getElementById('accessScreen').classList.add('hidden');
                    document.getElementById('startScreen').classList.remove('hidden');
                } else {
                    showAccessError(result.error || 'Invalid access code.');
                }
            } catch (error) {
                console.error('Error validating access code:', error);
                showAccessError('Connection error. Please try again.');
            } finally {
                accessBtn.disabled = false;
                accessBtn.textContent = 'Validate Access Code';
            }
        }

        function showAccessError(message) {
            const errorDiv = document.getElementById('accessError');
            errorDiv.textContent = '⚠️ ' + message;
            errorDiv.classList.remove('hidden');
        }

        function updateProjectInfo() {
            document.getElementById('projectName').textContent = projectData.name;
            document.getElementById('projectDescription').textContent = `Assessment for ${projectData.name} project`;
            
            const timeMinutes = Math.floor(projectData.time_limit / 60);
            document.getElementById('assessmentDetails').innerHTML = `
                <li>${questions.length} Multiple Choice Questions</li>
                <li>${timeMinutes} Minutes Time Limit</li>
                <li>Tests expertise in research methodology and implementation</li>
                <li>Covers statistical analysis, evaluation design, and technical problem-solving</li>
                <li>All questions are required</li>
                <li>Detailed results with explanations provided at the end</li>
                <li>You can move between questions before submitting</li>
            `;
        }

        // Initialize the quiz
        function startQuiz() {
            const nameInput = document.getElementById('participantName');
            participantName = nameInput.value.trim();
            
            if (!participantName) {
                alert('Please enter your name before starting the assessment.');
                return;
            }

            if (participantName.length < 2) {
                alert('Please enter your full name (at least 2 characters).');
                return;
            }

            // Record start time
            quizStartTime = new Date();

            // Hide start screen, show quiz screen
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');

            // Initialize quiz
            answers = {};
            currentQuestionIndex = 0;
            
            // Start timer
            startTimer();
            
            // Load first question
            loadQuestion();
            
            // Create question navigation grid
            createQuestionGrid();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('timer');
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running out
            if (timeLeft <= 300) { // 5 minutes
                timerElement.style.background = '#ff4444';
            } else if (timeLeft <= 600) { // 10 minutes
                timerElement.style.background = '#ff8800';
            }
        }

        function loadQuestion() {
            const question = questions[currentQuestionIndex];
            
            // Update question title and info
            document.getElementById('questionTitle').textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            document.getElementById('questionInfo').textContent = `${question.category}`;
            
            // Update question text
            document.getElementById('questionText').textContent = question.question;
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            // Create options
            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
                const li = document.createElement('li');
                li.className = 'option';
                
                const isSelected = answers[question.id] === optionLetter;
                if (isSelected) {
                    li.classList.add('selected');
                }
                
                li.innerHTML = `
                    <input type="radio" name="question${question.id}" value="${optionLetter}" ${isSelected ? 'checked' : ''}>
                    <span style="font-weight: bold; margin-right: 10px;">${optionLetter}.</span>
                    ${option}
                `;
                
                li.addEventListener('click', () => selectOption(question.id, optionLetter));
                optionsList.appendChild(li);
            });
            
            // Update navigation buttons
            updateNavigationButtons();
            updateQuestionGrid();
            
            // Hide validation error
            document.getElementById('validationError').classList.add('hidden');
        }

        function selectOption(questionId, optionLetter) {
            answers[questionId] = optionLetter;
            
            // Update visual selection
            const optionsList = document.getElementById('optionsList');
            const options = optionsList.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));
            
            const selectedOption = [...options].find(opt => 
                opt.querySelector('input').value === optionLetter
            );
            if (selectedOption) {
                selectedOption.classList.add('selected');
                selectedOption.querySelector('input').checked = true;
            }
            
            updateQuestionGrid();
            
            // Hide validation error if it was showing
            document.getElementById('validationError').classList.add('hidden');
        }

        function nextQuestion() {
            const currentQuestion = questions[currentQuestionIndex];
            
            // Check if current question is answered (mandatory)
            if (!answers[currentQuestion.id]) {
                document.getElementById('validationError').classList.remove('hidden');
                return;
            }
            
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function goToQuestion(index) {
            currentQuestionIndex = index;
            loadQuestion();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
        }

        function createQuestionGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < questions.length; i++) {
                const questionNum = document.createElement('div');
                questionNum.className = 'question-number';
                questionNum.textContent = i + 1;
                questionNum.onclick = () => goToQuestion(i);
                grid.appendChild(questionNum);
            }
            
            updateQuestionGrid();
        }

        function updateQuestionGrid() {
            const questionNumbers = document.querySelectorAll('.question-number');
            questionNumbers.forEach((num, index) => {
                num.className = 'question-number';
                
                if (index === currentQuestionIndex) {
                    num.classList.add('current');
                } else if (answers[questions[index].id]) {
                    num.classList.add('answered');
                }
            });
        }

        function createDetailedResults(score, total) {
            const container = document.getElementById('detailedResultsList');
            container.innerHTML = '';

            let correctCount = 0;
            let incorrectCount = 0;

            questions.forEach(question => {
                const userAnswer = answers[question.id];
                const isCorrect = userAnswer === question.correct;
                
                if (isCorrect) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }

                const resultDiv = document.createElement('div');
                resultDiv.className = `result-question ${isCorrect ? 'correct' : 'incorrect'}`;
                
                const optionTexts = {};
                question.options.forEach((option, index) => {
                    optionTexts[String.fromCharCode(65 + index)] = option;
                });

                resultDiv.innerHTML = `
                    <h4>Question ${question.id}: ${question.category}</h4>
                    <p style="margin-bottom: 10px;">${question.question}</p>
                    <div class="result-details">
                        ${!isCorrect ? `<p><span class="your-answer">Your answer: ${userAnswer}.</span> ${optionTexts[userAnswer]}</p>` : ''}
                        <p><span class="correct-answer">Correct answer: ${question.correct}.</span> ${optionTexts[question.correct]}</p>
                        <div class="explanation">
                            <strong>Explanation:</strong> ${question.explanation}
                        </div>
                    </div>
                `;
                
                container.appendChild(resultDiv);
            });

            // Add summary at the top
            const summaryDiv = document.createElement('div');
            summaryDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px; text-align: center;';
            summaryDiv.innerHTML = `
                <h4 style="color: #1976d2; margin-bottom: 10px;">Results Summary</h4>
                <p><strong>Correct:</strong> ${correctCount} questions | <strong>Incorrect:</strong> ${incorrectCount} questions</p>
                <p style="margin-top: 8px; font-size: 14px; color: #666;">
                    ${incorrectCount > 0 ? 'Review the incorrect answers below to learn more.' : 'Perfect score! Excellent work.'}
                </p>
            `;
            container.insertBefore(summaryDiv, container.firstChild);
        }

        async function submitQuiz() {
            // Check if all questions are answered
            const unansweredQuestions = [];
            questions.forEach(q => {
                if (!answers[q.id]) {
                    unansweredQuestions.push(q.id);
                }
            });
            
            if (unansweredQuestions.length > 0) {
                alert(`Please answer all questions before submitting. Missing: Question(s) ${unansweredQuestions.join(', ')}`);
                return;
            }
            
            // Calculate score and time taken
            let score = 0;
            questions.forEach(q => {
                if (answers[q.id] === q.correct) {
                    score++;
                }
            });

            const quizEndTime = new Date();
            const timeTakenSeconds = Math.floor((quizEndTime - quizStartTime) / 1000);
            
            // Stop timer
            clearInterval(timerInterval);
            
            // Show completion screen first
            showCompletionScreen(score, questions.length);
            
            // Create detailed results
            createDetailedResults(score, questions.length);
            
            // Prepare data for submission with project context
            const quizResult = {
                participant_name: participantName,
                project_id: projectData.id,
                period: 'baseline', // Default period, could be made configurable
                completed_at: quizEndTime.toISOString(),
                total_score: score,
                percentage: Math.round((score / questions.length) * 100),
                time_taken: timeTakenSeconds,
                total_questions: questions.length
            };
            
            // Add individual question responses
            questions.forEach(q => {
                quizResult[`Q${q.id}`] = answers[q.id] || '';
                quizResult[`Q${q.id}_correct`] = q.correct;
                quizResult[`Q${q.id}_skill`] = q.skill;
                quizResult[`Q${q.id}_category`] = q.category;
            });
            
            // Submit to backend
            await submitToDatabase(quizResult);
        }

        async function submitToDatabase(data) {
            const statusDiv = document.getElementById('submissionStatus');
            const statusMessage = document.getElementById('statusMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Show submission status
            statusDiv.classList.remove('hidden');
            statusMessage.textContent = 'Submitting your results...';
            loadingSpinner.style.display = 'block';
            
            console.log('Attempting to submit assessment data:', data);
            
            try {
                const response = await fetch('/api/submit-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Success response:', result);
                
                if (result.success) {
                    // Success
                    loadingSpinner.style.display = 'none';
                    statusMessage.textContent = `Results successfully saved! (ID: ${result.id})`;
                    statusDiv.style.background = '#e8f5e8';
                    statusDiv.style.color = '#2e7d2e';
                    statusDiv.style.borderLeftColor = '#11853d';
                    
                    console.log('Assessment submitted successfully:', result);
                } else {
                    throw new Error(result.error || 'Submission failed');
                }
            } catch (error) {
                console.error('Error submitting assessment:', error);
                
                // Show error but don't prevent completion
                loadingSpinner.style.display = 'none';
                statusMessage.textContent = `Warning: Results may not have been saved. Error: ${error.message}. Please inform the administrator.`;
                statusDiv.style.background = '#fff3e0';
                statusDiv.style.color = '#e65100';
                statusDiv.style.borderLeftColor = '#ff9800';
            }
        }

        function showCompletionScreen(score, total) {
            const percentage = Math.round((score / total) * 100);
            
            // Hide quiz screen, show completion screen
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('completionScreen').classList.remove('hidden');
            
            // Update completion screen
            document.getElementById('finalScore').textContent = `${score}/${total}`;
            document.getElementById('finalPercentage').textContent = `${percentage}%`;
            document.getElementById('thankYouMessage').textContent = `Thank you, ${participantName}!`;
            
            // Set icon and grade
            const icon = document.getElementById('completionIcon');
            const badge = document.getElementById('gradeBadge');
            
            if (percentage >= 80) {
                icon.textContent = '🎉';
                badge.textContent = 'Excellent';
                badge.className = 'grade-badge excellent';
            } else if (percentage >= 60) {
                icon.textContent = '👍';
                badge.textContent = 'Good';
                badge.className = 'grade-badge good';
            } else {
                icon.textContent = '📚';
                badge.textContent = 'Needs Improvement';
                badge.className = 'grade-badge needs-improvement';
            }
        }

        function resetQuiz() {
            // Reset all variables
            currentQuestionIndex = 0;
            answers = {};
            participantName = '';
            timeLeft = projectData ? projectData.time_limit : 1800;
            quizStartTime = null;
            
            // Clear timer
            clearInterval(timerInterval);
            
            // Reset forms
            document.getElementById('participantName').value = '';
            document.getElementById('accessCode').value = '';
            
            // Hide status message
            document.getElementById('submissionStatus').classList.add('hidden');
            
            // Show access screen
            document.getElementById('completionScreen').classList.add('hidden');
            document.getElementById('accessScreen').classList.remove('hidden');
            
            // Reset project data
            projectData = null;
            questions = [];
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            console.log('IPA Technical Assessment with Project Access Control loaded successfully');
        });

        // Prevent accidental page refresh during quiz
        window.addEventListener('beforeunload', function (e) {
            if (!document.getElementById('quizScreen').classList.contains('hidden')) {
                const confirmationMessage = 'Are you sure you want to leave? Your assessment progress will be lost.';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        // Handle page visibility change (tab switching, etc.)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && !document.getElementById('quizScreen').classList.contains('hidden')) {
                console.log('User switched tabs during assessment at:', new Date().toISOString());
                showProtectionOverlay();
            }
        });

        // Allow Enter key to submit access code
        document.getElementById('accessCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') validateAccess();
        });
    </script>
</body>
</html>