<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Assessment - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #666; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:hover:not(:disabled) { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .analytics-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .skill-area-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .skill-progress {
            background: #e0e0e0;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .skill-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .capacity-building {
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .priority-high { border-left-color: #f44336; }
        .priority-medium { border-left-color: #ff9800; }
        .priority-maintain { border-left-color: #4CAF50; }

        .participant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .participant-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .grade-badge {
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .excellent { background: #4CAF50; }
        .good { background: #FF9800; }
        .needs-improvement { background: #f44336; }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .password-screen {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .password-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .password-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .hidden { display: none; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .analytics-section {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="passwordScreen" class="password-screen">
        <h1>üîí Admin Access</h1>
        <p style="margin: 20px 0; color: #666;">Please enter the admin password to access the dashboard.</p>
        
        <div class="password-input">
            <input type="password" id="adminPassword" placeholder="Enter admin password" maxlength="50">
            <button class="btn btn-primary" onclick="login()">Login</button>
        </div>
        
        <p style="margin-top: 15px; font-size: 12px; color: #888;">
            Default password: <code>admin123</code>
        </p>
        
        <div id="loginError" class="error hidden"></div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <div class="container">
            <!-- Header -->
            <div class="card">
                <div class="header">
                    <div>
                        <h1>üìä Admin Dashboard</h1>
                        <p style="color: #666; margin-top: 5px;">Technical Assessment Analytics</p>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="card loading hidden">
                <h3>Loading dashboard data...</h3>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error hidden">
                <strong>‚ö†Ô∏è Connection Error</strong>
                <p id="errorMessage">Unable to load data from the server.</p>
            </div>

            <!-- Statistics Overview -->
            <div id="statsSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalParticipants">-</div>
                        <div class="stat-label">Total Participants</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-number" id="averageScore">-</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-number" id="todayCount">-</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-number" id="excellentCount">-</div>
                        <div class="stat-label">Excellent Scores (80%+)</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card">
                <h3 style="margin-bottom: 20px;">üõ†Ô∏è Actions</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="downloadCSV()" id="downloadBtn" disabled>
                        üì• Download Enhanced CSV
                    </button>
                    <button class="btn btn-secondary" onclick="checkHealth()">
                        üè• Health Check
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
                <div id="actionMessage" class="hidden"></div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="hidden">
                <!-- Skill Areas Analysis -->
                <div class="analytics-section">
                    <div class="card">
                        <h3>üìä Skill Areas Performance</h3>
                        <div id="skillAreasChart">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üéØ Capacity Building Plan</h3>
                        <div id="capacityBuildingPlan">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Individual Participant Analysis -->
                <div class="card">
                    <h3>üë• Individual Participant Analysis</h3>
                    <div id="participantAnalysis">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div id="resultsSection" class="card">
                <h3 style="margin-bottom: 20px;">üìà Recent Completions</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Participant</th>
                                <th>Score</th>
                                <th>Percentage</th>
                                <th>Data Analysis</th>
                                <th>Programming</th>
                                <th>Grade</th>
                                <th>Completed</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="card hidden" style="text-align: center; padding: 60px;">
                <div style="font-size: 4em; margin-bottom: 20px;">üìã</div>
                <h3>No Results Yet</h3>
                <p style="margin: 20px 0; color: #666;">Results will appear here once participants complete the quiz.</p>
                <a href="/" target="_blank" class="btn btn-primary">üöÄ Open Quiz Page</a>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'admin123';
        let quizResults = [];
        let analyticsData = null;

        // Authentication
        function login() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                loadDashboard();
            } else {
                showLoginError('‚ùå Incorrect password. Please try again.');
                document.getElementById('adminPassword').value = '';
            }
        }

        function logout() {
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        // Allow Enter key for password
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        // Dashboard Management
        async function loadDashboard() {
            await refreshData();
            setInterval(refreshData, 30000); // Auto-refresh every 30 seconds
        }

        async function refreshData() {
            try {
                showLoading();
                
                const [statsResponse, resultsResponse] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/results')
                ]);
                
                if (!statsResponse.ok || !resultsResponse.ok) {
                    throw new Error('Failed to fetch data from server');
                }
                
                const stats = await statsResponse.json();
                const results = await resultsResponse.json();
                
                quizResults = results;
                
                updateStatistics(stats);
                updateResultsTable(results);
                
                if (results.length > 0) {
                    await loadAnalytics();
                }
                
                toggleSections();
                hideError();
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to load data: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                if (!response.ok) throw new Error('Failed to fetch analytics');
                
                analyticsData = await response.json();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateStatistics(stats) {
            document.getElementById('totalParticipants').textContent = stats.total || 0;
            document.getElementById('averageScore').textContent = (stats.average_score || 0) + '%';
            document.getElementById('todayCount').textContent = stats.today_count || 0;
            document.getElementById('excellentCount').textContent = stats.excellent_count || 0;
            document.getElementById('downloadBtn').disabled = (stats.total || 0) === 0;
        }

        function updateResultsTable(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            results.forEach(result => {
                let dataAnalysisScore = 0;
                let programmingScore = 0;
                
                for (let i = 1; i <= 15; i++) {
                    const userAnswer = result[`Q${i}`];
                    const correctAnswer = result[`Q${i}_correct`];
                    const category = result[`Q${i}_category`];
                    
                    if (userAnswer === correctAnswer) {
                        if (category === 'Data Analysis') dataAnalysisScore++;
                        else if (category === 'Programming Logic') programmingScore++;
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.participant_name}</td>
                    <td>${result.total_score}/15</td>
                    <td>${result.percentage}%</td>
                    <td>${dataAnalysisScore}/10</td>
                    <td>${programmingScore}/5</td>
                    <td>
                        <span class="grade-badge ${getGradeClass(result.percentage)}">
                            ${getGradeText(result.percentage)}
                        </span>
                    </td>
                    <td>${formatDateTime(result.created_at)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAnalytics() {
            if (!analyticsData) return;

            // Update skill areas
            updateSkillAreas(analyticsData.skillAreas);
            
            // Update capacity building plan
            updateCapacityBuilding(analyticsData.capacityBuildingPlan);
            
            // Update participant analysis
            updateParticipantAnalysis(analyticsData.participantAnalysis);
        }

        function updateSkillAreas(skillAreas) {
            const container = document.getElementById('skillAreasChart');
            let html = '';
            
            skillAreas.forEach(area => {
                const color = area.averagePercentage >= 80 ? '#4CAF50' : 
                             area.averagePercentage >= 60 ? '#FF9800' : '#f44336';
                
                html += `
                    <div class="skill-area-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${area.name}</strong>
                                <div style="color: #666; font-size: 12px;">${area.participantScores.length} participants</div>
                            </div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${color};">
                                ${area.averagePercentage}%
                            </div>
                        </div>
                        <div class="skill-progress">
                            <div class="skill-progress-fill" style="background: ${color}; width: ${area.averagePercentage}%;"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateCapacityBuilding(plan) {
            const container = document.getElementById('capacityBuildingPlan');
            let html = '';
            
            plan.forEach(section => {
                const priorityClass = section.priority.includes('High') ? 'priority-high' :
                                    section.priority.includes('Medium') ? 'priority-medium' : 'priority-maintain';
                
                html += `
                    <div class="capacity-building ${priorityClass}">
                        <h4>${section.priority}</h4>
                        ${section.areas.map(area => `
                            <div style="margin: 10px 0;">
                                <strong>${area.name}</strong>
                                <div style="font-size: 12px; color: #666;">
                                    Current: ${area.currentLevel} ‚Üí Target: ${area.targetLevel}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateParticipantAnalysis(participants) {
            const container = document.getElementById('participantAnalysis');
            let html = '<div class="participant-grid">';
            
            participants.forEach(participant => {
                html += `
                    <div class="participant-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${participant.name}</strong>
                            <span class="grade-badge ${getGradeClass(participant.percentage)}">
                                ${participant.percentage}%
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px;">
                `;
                
                Object.entries(participant.skillAreas).forEach(([area, data]) => {
                    const color = data.percentage >= 80 ? '#4CAF50' : 
                                 data.percentage >= 60 ? '#FF9800' : '#f44336';
                    
                    html += `
                        <div style="background: #f8f9fa; padding: 5px; border-radius: 4px;">
                            <div style="font-weight: bold; color: ${color};">${data.percentage}%</div>
                            <div style="color: #666;">${area.replace(' & ', ' & ')}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleSections() {
            const hasResults = quizResults.length > 0;
            document.getElementById('analyticsSection').classList.toggle('hidden', !hasResults);
            document.getElementById('resultsSection').classList.toggle('hidden', !hasResults);
            document.getElementById('emptyState').classList.toggle('hidden', hasResults);
        }

        // Utility Functions
        function getGradeClass(percentage) {
            if (percentage >= 80) return 'excellent';
            if (percentage >= 60) return 'good';
            return 'needs-improvement';
        }

        function getGradeText(percentage) {
            if (percentage >= 80) return 'Excellent';
            if (percentage >= 60) return 'Good';
            return 'Needs Improvement';
        }

        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString();
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }

        function showActionMessage(message, isError = false) {
            const div = document.getElementById('actionMessage');
            div.textContent = message;
            div.className = isError ? 'error' : 'success';
            setTimeout(() => div.classList.add('hidden'), 5000);
        }

        // Action Functions
        async function downloadCSV() {
            try {
                const response = await fetch('/api/download-csv');
                if (!response.ok) throw new Error('Failed to download CSV');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `technical_assessment_results_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showActionMessage(`‚úÖ CSV downloaded successfully! (${quizResults.length} records)`);
                
            } catch (error) {
                console.error('Error downloading CSV:', error);
                showActionMessage('Failed to download CSV: ' + error.message, true);
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok && data.status === 'OK') {
                    showActionMessage('üè• Server health check passed. Database is operational.');
                } else {
                    throw new Error(data.message || 'Health check failed');
                }
                
            } catch (error) {
                console.error('Health check failed:', error);
                showActionMessage('Health check failed: ' + error.message, true);
            }
        }

        async function clearAllData() {
            if (quizResults.length === 0) {
                showActionMessage('No data to clear.', true);
                return;
            }

            const confirmed = confirm(`‚ö†Ô∏è Are you sure you want to delete all ${quizResults.length} quiz results?\n\nThis action cannot be undone.`);
            
            if (confirmed) {
                try {
                    const response = await fetch('/api/results', { method: 'DELETE' });
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showActionMessage('‚úÖ All data cleared successfully.');
                        await refreshData();
                    } else {
                        throw new Error(result.error || 'Failed to clear data');
                    }
                    
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showActionMessage('Failed to clear data: ' + error.message, true);
                }
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('Admin dashboard loaded');
        });
    </script>
</body>
</html>